# intercom
Connecting an analog intercom to voip

Идея такова.
Многие из нас проживают в многоквартирных домах. И, конечно, используют при этом самый обыкновенный
координатно-матричный домофон. Например таких марок как: Цифраль, метаком, Пиррс. 
Я уже продолжительное время работаю удалённо и всякий раз, когда слышу звонок домофона (или не слышу, когда в наушниках) я вынужден вставать и идти к входной двери, где чаще всего и установлена переговорная трубка.

Я задумался. "А как же сделать так, чтобы подключить древний домофон к, например, смартфону?". И чтобы работали все функции:

- Звонок
- Выключение звонка (режим DND)
- Оповещение о визите с возможностью записи разговора или автоответчика
- Режим разговора
- Удалённое открытие с использованием стандартных функций смартфона или с помощью приложения
- Переадресация или параллельный вызов, если никто не отвечает (Часто дети забывают ключи и не могут попасть в подъезд)

Готового решения, для подключения к координатно-матричному интекому я не смог найти. Однако:

1. Готовые решения для подключения к видео-домофону (с использованием специальных плат сопряжения). Для этого необходимо приобрести плату сопряжения и сам видеодомофон
2. Готовые решения для подключения к видео-IP домофону (с использованием специальных плат сопряжения). Для этого необходимо приобрести плату сопряжения и сам видеодомофон
3. Готовые решения для подключения к проводному или DECT телефону (с использованием специальных адаптеров-иммитаторов АТС). Для этого необходимо приобрести адаптер.

Что я делаю. Соединяю Рещение 3 (адаптер-иммитатор АТС)с решением 1 (плата сопряжения для видеодомофона). Полученный мутант я подключаю к VOIP шлюзу на порт FXS.
Далее обрабатываю звонки (вызов посетителя) через VOIP или АТС на любом популярной SIP-платформе. Команды открытия/отбоя - стандартные DTMF (готовый обработчик уже есть в решении 3).

Принять вызов можно несколькими способами

1. Обычный проводной телефон или DECT
2. SIP клиент (desktop, andriod, ios)
3. Переадресация на любой SIP или телефон.
4. Приложение на смартфоне, которое просто откроет дверь


Заработало это не сразу и не так, как хотелось, но заработало.

Итак, что мне удалось соеденить между собой:

1. Модуль подключения вызывной панели видеодомофона к стационарному телефону https://slinex.ru/product/slinex-xr-27 (инструкция подключения и инструкция по эксплуатации там же по ссылке на странице)

2. Адаптер домофона Adapterra D506 http://adapterra.com/

Этот тип адаптера использут упрощённую обработку аналоговых сигналов без применения HOOK (https://domofon-ks.dp.ua/vs-pro-domofon/chto-takoe-signal-hook-v-domofone) и снимает трубку не зависимо от ответа абонента, переводя систему в режим разговора.

3. Адаптер домофона МСК Слим http://dacsys.ru/index.php/51-catalog/ms/175-msk-slim (инструкция подключения и инструкция по эксплуатации там же по ссылке на странице)

Этот тип адаптера использут улучшенную обработку обработку аналоговых сигналов с применением сигнала HOOK (https://domofon-ks.dp.ua/vs-pro-domofon/chto-takoe-signal-hook-v-domofone)  и снимает трубку только, если есть ответ абонента (вызываемый абонент снял трубку, нажал на кнопку "разговор"), переводя систему в режим разговора.

4. VOIP шлюз с функцией мини-АТС - https://en.avm.de/fileadmin/user_upload/EN/Manuals/FRITZ_Box/more_Box/Manual_FRITZBox_Fon_WLAN_7140.pdf и форум на железку https://forum.ixbt.com/topic.cgi?id=14:51963

Это оборудование позволяет подключить два телефонных аппарата (порт FXO) - любым из двух аппаратов можно принимать входящий вызов от абонента. 
Также в нём есть самое главное - порт FXS - в этот порт подключаем модуль подключения вызывной панели видеодомофона к стационарному телефону Slinex.

При тестировании совместной работы, я убедился, что для нормальной работы системы не подходит адаптер домофона Adapterra D506 . Он прекрасно иммитирует работу трубки Cyfral: ожидает вызов (нагружая линию 50 Ом), принимает вызов, открывает замок, завершат вызов. Но есть один большой недостаток - при поступления вызова от абонента с подъезной вызывной панели, адаптер через 5 - 6 секунд просто снимает трубку, не зависимо от того, снял ли вызываемый абонент физически трубку или нет. Что при этом происходит - посетитель набирает номер абонента (квартиры), нажимает кнопку вызова, слышит гудки вызова, а затем тишина пока абонент не поднимет трубку. В инструкци по установке и настройке написано, что такое поведение нормально и позволяет иммитировать присутствие жилица в помещении. Странно, но мне такое не подходит. 

Поэтому я заказал адаптер другого производителя - это адаптер домофона МСК Слим (пункт 3). Здесь есть главное преемущество - ответ на вызов происходит только тогда, когда есть ответ абонента (вызываемый абонент снял трубку, нажал на кнопку "разговор"), переводя систему в режим разговора. Детектирование момента снятия трубки осуществляется разрыванием специального сигнального провода, притянутового на землю. Проще говоря, Когда поступает вызов, провод "HOOK" соединён с землей. и пока я не разорву контакт с землёй, вызов так и будет поступать, пока не надоест посетителю или домофону (не прилетит тамаут). Если HOOK оставить не подключённым при монтаже, то адаптер просто сразу начнет разговор при поступлении вызова. 

В Модуль подключения вызывной панели видеодомофона к стационарному телефону slinex-xr-27 нет функции HOOK. Поэтому просто так определить состояние трубки не представляется возможным. При детальном изучении инструкции, вsяснилось, что есть некий сигнальный провод (номер 8), который используется для корректной совместной работы с домофонной системой Slinex XR-07 и XR-07M. Я подключил осциллограф/вольтметр к этому выводу. Я обнаружил, что при снятии трубки телефона, подключённого к slinex-xr-27 на выводе номер 8 возникает кратковременный сигнал амплитудой +0,26 В. Как это можно использовать для определения начала разговора (снятия трубки)? Нужно детектировать сигнал, и разомкнуть провод HOOK. Этого будет достаточно для корректной работы всей системы.

Для этого нам понадобится:
1. Китайское реле на 5 или 12 В, например вот такое https://arduino.by/item/modul-rele-1-kanal-5v 
2. модуль arduino UNO, например такой http://arduino.ru/Hardware/ArduinoBoardNano

Ардуино Nano выполняет функцию аналогового вольтметра с возможностью измерения импульса +0,26 В без использования делителя наряжения. Нам нужно только детектировать импульс больше, чем +0,18 (Это необходимо для корректного измерения)

Реле размыкает провод HOOK при определении импульса. Программный код  вот здесь https://github.com/alex-absent/intercom/blob/main/HOOK.ino

Принцип работы программы следующий:

1. Включаем аналоговый вход, фильтруем шум (500 мс)
2. Слушаем сигнал на аналоговом входе (1) до тех пор, пока не определим, что в выборке измерений среднее значение станет равным больше, чем 180 мВ. Переключаем реле и ждём 100 сек или до заваершения вызова (этого таймаута вполне достаточно)

Плата ардуино и реле активны только при поступлении вызова на плату сопряжения. В режиме ожидания питание на ардуино отсутствует, реле в нормально замкнутом положении. При этом HOOK замкнут на землю.

Только после этого мне удалось добиться нормальной работы всей системы. Теперь возможно ответить на вызов посетителя, совершить разговор, открыть замок, завершить вызов без открытия замка.

Далее подключаем непосредственно VOIP шлюз (Fritz-box 7140) вместо телефонного аппарата в порт 2 Slinex XR-27, а телефонный аппарат в один из выходов. Это позволяет расширить функционал следующим образом:

1. При поступлении вызова от посетителя, звнок с помощью встроенной мини-атс перадресуется или дублируется (parallel call) в на SIP клиент или облачную атс. В моем случае это: sip-клиент zadarma с возможностью открытия замка (DTMF).
2. При поступлении вызова от посетителя, звнок с помощью встроенной мини-атс перадресуется или дублируется (parallel call) в на любой номер, привязанный к SIP-аккаунту. В моем случае это: Просто входящий вызов с облачной АТС с возможностью открытия замка (DTMF).
3. Различные возможности облачной АТС, такие как: Автответчик, мелодия ожидания ответа абонента.

4. Мобильное или десктопное приложение с возможностью управления VOIP шлюзом или доступом к облачной платформе - это пока в разработке.
